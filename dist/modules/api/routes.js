"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.router = void 0;
const express = require("express");
const express_1 = require("hyper-ts/lib/express");
const model_1 = require("../issue/model");
const pipeable_1 = require("fp-ts/pipeable");
const H = require("hyper-ts");
const errors_1 = require("../errors");
const PathReporter_1 = require("io-ts/PathReporter");
const common_1 = require("./common");
const mongodb_1 = require("mongodb");
const issue_1 = require("../issue/issue");
const mongo_1 = require("../mongo");
const router = express.Router();
exports.router = router;
const createIssueRequestHandler = pipeable_1.pipe(H.decodeBody(model_1.createIssueInput.decode), H.mapLeft((e) => errors_1.createBackendError(PathReporter_1.failure(e).join('\n'), errors_1.ErrorTag.api)(e)), H.ichain((decoded) => H.fromTaskEither(issue_1.createIssue(decoded))), H.ichain(common_1.sendBodyAndClose('createIssueHandler JSON error')), H.orElse(common_1.withErrorCode(H.Status.BadRequest)));
router.route('/createIssue').post(express_1.toRequestHandler(createIssueRequestHandler));
const getIssueByIdHandler = pipeable_1.pipe(H.decodeParam("id", mongo_1.objectIdstring.decode), H.map((decoded) => new mongodb_1.ObjectID(decoded)), H.mapLeft((e) => errors_1.createBackendError(PathReporter_1.failure(e).join('\n'), errors_1.ErrorTag.api)(e)), H.ichain((decoded) => H.fromTaskEither(issue_1.getIssueById(model_1.isoIssueId.wrap(decoded)))), H.ichain(common_1.sendBodyAndClose('getIssueByIdHandler JSON error')), H.orElse(common_1.withErrorCode(H.Status.BadRequest)));
router.route('/getIssue').get(express_1.toRequestHandler(getIssueByIdHandler));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZHVsZXMvYXBpL3JvdXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFDbkMsa0RBQXNEO0FBQ3RELDBDQUFvRjtBQUNwRiw2Q0FBb0M7QUFDcEMsOEJBQThCO0FBQzlCLHNDQUF1RDtBQUN2RCxxREFBMkM7QUFDM0MscUNBQXlEO0FBQ3pELHFDQUFpQztBQUNqQywwQ0FBeUQ7QUFDekQsb0NBQXdDO0FBRXhDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQXVCeEIsd0JBQU07QUFyQmQsTUFBTSx5QkFBeUIsR0FBRyxlQUFJLENBQ2xDLENBQUMsQ0FBQyxVQUFVLENBQUMsd0JBQWdCLENBQUMsTUFBTSxDQUFDLEVBQ3JDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLDJCQUFrQixDQUFDLHNCQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLGlCQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDNUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxtQkFBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFDN0QsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx5QkFBZ0IsQ0FBQywrQkFBK0IsQ0FBQyxDQUFDLEVBQzNELENBQUMsQ0FBQyxNQUFNLENBQUMsc0JBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQy9DLENBQUM7QUFFRixNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQywwQkFBZ0IsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7QUFFL0UsTUFBTSxtQkFBbUIsR0FBRyxlQUFJLENBQzVCLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLHNCQUFjLENBQUMsTUFBTSxDQUFDLEVBQzFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksa0JBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUN6QyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQywyQkFBa0IsQ0FBQyxzQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxpQkFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQzVFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsb0JBQVksQ0FBQyxrQkFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDL0UsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx5QkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLEVBQzVELENBQUMsQ0FBQyxNQUFNLENBQUMsc0JBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQy9DLENBQUM7QUFFRixNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQywwQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMifQ==