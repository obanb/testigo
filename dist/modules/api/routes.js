"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.router = void 0;
const express = require("express");
const express_1 = require("hyper-ts/lib/express");
const model_1 = require("../issue/model");
const pipeable_1 = require("fp-ts/pipeable");
const H = require("hyper-ts");
const errors_1 = require("../errors");
const PathReporter_1 = require("io-ts/PathReporter");
const common_1 = require("./common");
const mongodb_1 = require("mongodb");
const issue_1 = require("../issue/issue");
const mongo_1 = require("../mongo");
const models_1 = require("../account/models");
const router = express.Router();
exports.router = router;
const createIssueRequestHandler = pipeable_1.pipe(H.decodeBody(model_1.createIssueInput.decode), H.mapLeft((e) => errors_1.createBackendError(PathReporter_1.failure(e).join('\n'), errors_1.ErrorTag.api)(e)), H.ichain((decoded) => H.fromTaskEither(issue_1.createIssue(decoded))), H.ichain(common_1.sendBodyAndClose('createIssueHandler JSON error')), H.orElse(common_1.withErrorCode(H.Status.BadRequest)));
const getIssueByIdHandler = pipeable_1.pipe(H.decodeParam('id', mongo_1.objectIdstring.decode), H.map((decoded) => new mongodb_1.ObjectID(decoded)), H.mapLeft((e) => errors_1.createBackendError(PathReporter_1.failure(e).join('\n'), errors_1.ErrorTag.api)(e)), H.ichain((decoded) => H.fromTaskEither(issue_1.getIssueById(model_1.isoIssueId.wrap(decoded)))), H.ichain(common_1.sendBodyAndClose('getIssueByIdHandler JSON error')), H.orElse(common_1.withErrorCode(H.Status.BadRequest)));
const getIssuesHandler = pipeable_1.pipe(H.decodeParams(common_1.emptyObject.decode), H.mapLeft((e) => errors_1.createBackendError(PathReporter_1.failure(e).join('\n'), errors_1.ErrorTag.api)(e)), H.ichain((_) => H.fromTaskEither(issue_1.getIssues())), H.ichain(common_1.sendBodyAndClose('getIssuesHandler JSON error')), H.orElse(common_1.withErrorCode(H.Status.BadRequest)));
const createAccountRequestHandler = pipeable_1.pipe(H.decodeBody(models_1.createAccountInput.decode), H.mapLeft((e) => errors_1.createBackendError(PathReporter_1.failure(e).join('\n'), errors_1.ErrorTag.api)(e)), H.ichain((decoded) => H.fromTaskEither(models_1.checkAccountExists(decoded))), H.ichain(common_1.sendBodyAndClose('createAccountRequestHandler JSON error')), H.orElse(common_1.withErrorCode(H.Status.BadRequest)));
router.route('/createIssue').post(express_1.toRequestHandler(createIssueRequestHandler));
router.route('/getIssue/:id').get(express_1.toRequestHandler(getIssueByIdHandler));
router.route('/getIssues').get(express_1.toRequestHandler(getIssuesHandler));
router.route('/createAccount').post(express_1.toRequestHandler(createAccountRequestHandler));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZHVsZXMvYXBpL3JvdXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFDbkMsa0RBQXNEO0FBQ3RELDBDQUE0RDtBQUM1RCw2Q0FBb0M7QUFDcEMsOEJBQThCO0FBQzlCLHNDQUF1RDtBQUN2RCxxREFBMkM7QUFDM0MscUNBQXNFO0FBQ3RFLHFDQUFpQztBQUNqQywwQ0FBb0U7QUFDcEUsb0NBQXdDO0FBQ3hDLDhDQUF3RjtBQUV4RixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7QUEyQ3hCLHdCQUFNO0FBekNkLE1BQU0seUJBQXlCLEdBQUcsZUFBSSxDQUNsQyxDQUFDLENBQUMsVUFBVSxDQUFDLHdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUNyQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQywyQkFBa0IsQ0FBQyxzQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxpQkFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQzVFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsbUJBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQzdELENBQUMsQ0FBQyxNQUFNLENBQUMseUJBQWdCLENBQUMsK0JBQStCLENBQUMsQ0FBQyxFQUMzRCxDQUFDLENBQUMsTUFBTSxDQUFDLHNCQUFhLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUMvQyxDQUFDO0FBRUYsTUFBTSxtQkFBbUIsR0FBRyxlQUFJLENBQzVCLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLHNCQUFjLENBQUMsTUFBTSxDQUFDLEVBQzFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksa0JBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUN6QyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQywyQkFBa0IsQ0FBQyxzQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxpQkFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQzVFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsb0JBQVksQ0FBQyxrQkFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDL0UsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx5QkFBZ0IsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLEVBQzVELENBQUMsQ0FBQyxNQUFNLENBQUMsc0JBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQy9DLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUFHLGVBQUksQ0FDekIsQ0FBQyxDQUFDLFlBQVksQ0FBQyxvQkFBVyxDQUFDLE1BQU0sQ0FBQyxFQUNsQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQywyQkFBa0IsQ0FBQyxzQkFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxpQkFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQzVFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsaUJBQVMsRUFBRSxDQUFDLENBQUMsRUFDOUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx5QkFBZ0IsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDLEVBQ3pELENBQUMsQ0FBQyxNQUFNLENBQUMsc0JBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQy9DLENBQUM7QUFFRixNQUFNLDJCQUEyQixHQUFHLGVBQUksQ0FDcEMsQ0FBQyxDQUFDLFVBQVUsQ0FBQywyQkFBa0IsQ0FBQyxNQUFNLENBQUMsRUFDdkMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsMkJBQWtCLENBQUMsc0JBQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsaUJBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUM1RSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLDJCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFDcEUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyx5QkFBZ0IsQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDLEVBQ3BFLENBQUMsQ0FBQyxNQUFNLENBQUMsc0JBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQy9DLENBQUM7QUFFRixNQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQywwQkFBZ0IsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7QUFFL0UsTUFBTSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLENBQUMsMEJBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0FBRXpFLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsR0FBRyxDQUFDLDBCQUFnQixDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQztBQUVuRSxNQUFNLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsSUFBSSxDQUFDLDBCQUFnQixDQUFDLDJCQUEyQixDQUFDLENBQUMsQ0FBQyJ9